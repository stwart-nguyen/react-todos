Change flow, and fix bug
